name: Test Raytracer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install Git LFS
      run: |
        sudo apt-get update
        sudo apt-get install -y git-lfs
        git lfs install
        
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true
        
    - name: Pull LFS files
      run: git lfs pull
        
    - name: Set up C++ compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make
        
    - name: Build raytracer
      run: |
        chmod +x TestScripts/build.sh
        ./TestScripts/build.sh
        
    - name: Run binary scene test
      id: test_binary
      run: |
        chmod +x TestScripts/render_binary.sh
        ./TestScripts/render_binary.sh || echo "test_failed=true" >> $GITHUB_OUTPUT
        
    - name: Run phong scene test
      id: test_phong
      run: |
        chmod +x TestScripts/render_phong.sh
        ./TestScripts/render_phong.sh || echo "test_failed=true" >> $GITHUB_OUTPUT
        
    - name: Upload test outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-outputs
        path: |
          TestOutput/*.ppm
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Verify LFS files are checked out
      run: |
        echo "Checking if LFS files are properly checked out..."
        if [ -f "TestSuite/binary_scene.ppm" ]; then
          file_size=$(stat -c%s "TestSuite/binary_scene.ppm" 2>/dev/null || echo "0")
          # LFS pointer files are typically very small (< 200 bytes)
          if [ "$file_size" -lt 200 ]; then
            echo "⚠️ Warning: binary_scene.ppm appears to be a LFS pointer file (size: $file_size bytes)"
            echo "LFS files may not be properly checked out. Running 'git lfs pull' again..."
            git lfs pull
            file_size=$(stat -c%s "TestSuite/binary_scene.ppm" 2>/dev/null || echo "0")
            echo "After pull: size is $file_size bytes"
          else
            echo "✅ binary_scene.ppm appears to be checked out (size: $file_size bytes)"
          fi
        else
          echo "❌ TestSuite/binary_scene.ppm not found"
        fi
        
    - name: Verify test results
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        FAILED=0
        
        # Check binary_scene test
        if [ -f "TestOutput/binary_scene.ppm" ] && [ -f "TestSuite/binary_scene.ppm" ]; then
          if cmp -s "TestOutput/binary_scene.ppm" "TestSuite/binary_scene.ppm"; then
            echo "✅ **binary_scene.ppm**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **binary_scene.ppm**: FAILED (output differs from reference)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
        elif [ ! -f "TestOutput/binary_scene.ppm" ]; then
          echo "⚠️ **binary_scene.ppm**: Output file not generated" >> $GITHUB_STEP_SUMMARY
          FAILED=1
        elif [ ! -f "TestSuite/binary_scene.ppm" ]; then
          echo "⚠️ **binary_scene.ppm**: Reference file not found (skipping comparison)" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check phong_scene tests
        if [ -f "TestOutput/phong_scene.ppm" ] && [ -f "TestSuite/phong_scene.ppm" ]; then
          if cmp -s "TestOutput/phong_scene.ppm" "TestSuite/phong_scene.ppm"; then
            echo "✅ **phong_scene.ppm**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **phong_scene.ppm**: FAILED (output differs from reference)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
        elif [ ! -f "TestOutput/phong_scene.ppm" ]; then
          echo "⚠️ **phong_scene.ppm**: Output file not generated" >> $GITHUB_STEP_SUMMARY
          FAILED=1
        elif [ ! -f "TestSuite/phong_scene.ppm" ]; then
          echo "⚠️ **phong_scene.ppm**: Reference file not found (skipping comparison)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "TestOutput/phong_scene_RAW.ppm" ] && [ -f "TestSuite/phong_scene_RAW.ppm" ]; then
          if cmp -s "TestOutput/phong_scene_RAW.ppm" "TestSuite/phong_scene_RAW.ppm"; then
            echo "✅ **phong_scene_RAW.ppm**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **phong_scene_RAW.ppm**: FAILED (output differs from reference)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi
        elif [ ! -f "TestOutput/phong_scene_RAW.ppm" ]; then
          echo "⚠️ **phong_scene_RAW.ppm**: Output file not generated" >> $GITHUB_STEP_SUMMARY
          FAILED=1
        elif [ ! -f "TestSuite/phong_scene_RAW.ppm" ]; then
          echo "⚠️ **phong_scene_RAW.ppm**: Reference file not found (skipping comparison)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ $FAILED -eq 1 ]; then
          echo "### ❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "### ✅ All tests passed" >> $GITHUB_STEP_SUMMARY
        fi
